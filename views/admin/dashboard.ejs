<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Perfume Store</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header', { user: typeof user !== 'undefined' ? user : null }) %>
  
  <main>
    <section class="admin-page">
      <div class="container">
        <h1>Admin Dashboard</h1>
        
        <div class="admin-tabs">
          <button class="tab-btn active" onclick="showTab('products')">Products</button>
          <button class="tab-btn" onclick="showTab('orders')">Orders</button>
        </div>

        <div id="products-tab" class="tab-content active">
          <h2>Product Management</h2>
          <button onclick="showAddProductForm()" class="btn btn-primary">Add New Product</button>
          <div id="add-product-form" class="form-container" style="display: none;">
            <h3>Add Product</h3>
            <form id="product-form">
              <div class="form-group">
                <label>Name:</label>
                <input type="text" id="product-name" required>
              </div>
              <div class="form-group">
                <label>Description:</label>
                <textarea id="product-description"></textarea>
              </div>
              <div class="form-group">
                <label>Price:</label>
                <input type="number" id="product-price" step="0.01" required>
              </div>
              <div class="form-group">
                <label>Image URL:</label>
                <input type="url" id="product-image">
              </div>
              <div class="form-group">
                <label>Stock:</label>
                <input type="number" id="product-stock" required>
              </div>
              <div class="form-group">
                <label>Category:</label>
                <select id="product-category">
                  <option value="Men">Men</option>
                  <option value="Women">Women</option>
                  <option value="Unisex">Unisex</option>
                </select>
              </div>
              <div class="form-group">
                <label>Brand:</label>
                <input type="text" id="product-brand">
              </div>
              <button type="submit" class="btn btn-primary">Save Product</button>
              <button type="button" onclick="hideAddProductForm()" class="btn btn-secondary">Cancel</button>
            </form>
          </div>
          <div id="products-list">
            <!-- Products will be loaded here -->
          </div>
        </div>

        <div id="orders-tab" class="tab-content">
          <h2>Order Management</h2>
          <div id="orders-list">
            <!-- Orders will be loaded here -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <%- include('../partials/footer') %>

  <script src="/js/main.js"></script>
  <script>
    let editingProductId = null;

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      event.target.classList.add('active');

      if (tab === 'products') {
        loadProducts();
      } else if (tab === 'orders') {
        loadOrders();
      }
    }

    function showAddProductForm() {
      document.getElementById('add-product-form').style.display = 'block';
      editingProductId = null;
      document.getElementById('product-form').reset();
    }

    function hideAddProductForm() {
      document.getElementById('add-product-form').style.display = 'none';
      editingProductId = null;
    }

    function loadProducts() {
      fetch('/admin/products')
        .then(res => res.json())
        .then(products => {
          const container = document.getElementById('products-list');
          container.innerHTML = products.map(product => `
            <div class="admin-product-card">
              <img src="${product.image_url}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/100'">
              <div class="product-info">
                <h3>${product.name}</h3>
                <p>$${product.price.toFixed(2)} | Stock: ${product.stock} | ${product.category}</p>
              </div>
              <div class="product-actions">
                <button onclick="editProduct(${product.id})" class="btn btn-secondary">Edit</button>
                <button onclick="deleteProduct(${product.id})" class="btn btn-danger">Delete</button>
              </div>
            </div>
          `).join('');
        })
        .catch(err => console.error('Error loading products:', err));
    }

    function editProduct(id) {
      fetch(`/api/products/${id}`)
        .then(res => res.json())
        .then(product => {
          document.getElementById('product-name').value = product.name;
          document.getElementById('product-description').value = product.description || '';
          document.getElementById('product-price').value = product.price;
          document.getElementById('product-image').value = product.image_url || '';
          document.getElementById('product-stock').value = product.stock;
          document.getElementById('product-category').value = product.category || 'Men';
          document.getElementById('product-brand').value = product.brand || '';
          editingProductId = id;
          document.getElementById('add-product-form').style.display = 'block';
        });
    }

    function deleteProduct(id) {
      if (confirm('Are you sure you want to delete this product?')) {
        fetch(`/admin/products/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            loadProducts();
          })
          .catch(err => alert('Error deleting product'));
      }
    }

    function loadOrders() {
      fetch('/admin/orders')
        .then(res => res.json())
        .then(orders => {
          const container = document.getElementById('orders-list');
          container.innerHTML = orders.map(order => `
            <div class="admin-order-card">
              <div class="order-info">
                <h3>Order #${order.id}</h3>
                <p>User: ${order.user_name} (${order.email})</p>
                <p>Total: $${order.total_amount.toFixed(2)}</p>
                <p>Date: ${new Date(order.created_at).toLocaleDateString()}</p>
                <p>Status: <span class="status-${order.status}">${order.status}</span></p>
              </div>
              <div class="order-actions">
                <select onchange="updateOrderStatus(${order.id}, this.value)">
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                  <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
              </div>
            </div>
          `).join('');
        })
        .catch(err => console.error('Error loading orders:', err));
    }

    function updateOrderStatus(orderId, status) {
      fetch(`/admin/orders/${orderId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      })
      .then(res => res.json())
      .then(data => {
        loadOrders();
      })
      .catch(err => alert('Error updating order status'));
    }

    document.getElementById('product-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        price: parseFloat(document.getElementById('product-price').value),
        image_url: document.getElementById('product-image').value,
        stock: parseInt(document.getElementById('product-stock').value),
        category: document.getElementById('product-category').value,
        brand: document.getElementById('product-brand').value
      };

      const url = editingProductId ? `/admin/products/${editingProductId}` : '/admin/products';
      const method = editingProductId ? 'PUT' : 'POST';

      fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(productData)
      })
      .then(res => res.json())
      .then(data => {
        hideAddProductForm();
        loadProducts();
      })
      .catch(err => alert('Error saving product'));
    });

    loadProducts();
  </script>
</body>
</html>